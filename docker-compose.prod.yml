services:
  # MongoDB is now hosted externally (MongoDB Atlas or remote server)
  # Configure MONGODB_URI in .env file

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: all-thing-eye-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
      - ./data/logs/nginx:/var/log/nginx
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
    networks:
      - all-thing-eye
    environment:
      TZ: Asia/Seoul

  # FastAPI Backend (MongoDB)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: all-thing-eye-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Timezone
      TZ: Asia/Seoul

      # MongoDB Connection
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-all_thing_eye}

      # GitHub Plugin
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_ORG: ${GITHUB_ORG}

      # Slack Plugin & Bot
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_USER_TOKEN: ${SLACK_USER_TOKEN}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}

      # Notion Plugin
      NOTION_TOKEN: ${NOTION_TOKEN}

      # Google Drive Plugin
      GOOGLE_APPLICATION_CREDENTIALS: /app/config/google_drive/credentials.json
      GOOGLE_ADMIN_EMAIL: ${GOOGLE_ADMIN_EMAIL}

      # Translation API (Tokamak AI - qwen3-80b-next)
      TRANSLATION_API_KEY: ${TRANSLATION_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY} # Legacy, kept for backward compatibility

      # Admin Addresses (comma-separated)
      ADMIN_ADDRESSES: ${ADMIN_ADDRESSES}

      # AI API (Tokamak)
      AI_API_KEY: ${AI_API_KEY}
      AI_API_URL: ${AI_API_URL:-https://api.ai.tokamak.network}

      # Support Bot (HTTP Events API)
      SLACK_SUPPORT_BOT_TOKEN: ${SLACK_SUPPORT_BOT_TOKEN}
      SLACK_SUPPORT_SIGNING_SECRET: ${SLACK_SUPPORT_SIGNING_SECRET}
      SLACK_SUPPORT_ADMIN_ID: ${SLACK_SUPPORT_ADMIN_ID}
      EXECUTOR_SECRET: ${EXECUTOR_SECRET}
    volumes:
      - ./config:/app/config:ro
      - ./data/logs/backend:/app/logs
    expose:
      - "8000"
    # MongoDB is now remote - no local dependency
    networks:
      - all-thing-eye
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8000/health', timeout=5)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Next.js Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    container_name: all-thing-eye-frontend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Seoul
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    expose:
      - "3000"
    depends_on:
      - backend
    networks:
      - all-thing-eye

  # Data Collection Scheduler (Cron-like service)
  # NOTE: Notion is excluded - use notion-diff-collector for real-time Notion tracking
  data-collector:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: all-thing-eye-data-collector
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Seoul

      # MongoDB Connection
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-all_thing_eye}

      # API Tokens
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_ORG: ${GITHUB_ORG}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_USER_TOKEN: ${SLACK_USER_TOKEN}
      GOOGLE_APPLICATION_CREDENTIALS: /app/config/google_drive/credentials.json
      GOOGLE_ADMIN_EMAIL: ${GOOGLE_ADMIN_EMAIL}
    volumes:
      - ./config:/app/config:ro
      - ./data/logs/collector:/app/logs
    # MongoDB is now remote - no local dependency
    networks:
      - all-thing-eye
    command: >
      bash -c "
        echo '[INFO] Data Collector starting...'
        echo '[INFO] Timezone: $$(date +%Z)'
        echo '[INFO] Current time: $$(date)'
        echo '[INFO] Waiting 60 seconds for backend to initialize...'
        sleep 60
        
        echo '[INFO] Running initial data collection (2 weeks) - GitHub, Slack, Drive only...'
        python scripts/initial_data_collection_mongo.py --days 14 --sources github slack drive
        
        echo '[INFO] Building member index...'
        python scripts/build_member_index_mongo.py
        
        echo '[INFO] Initial setup complete. Starting daily collection scheduler...'
        
        while true; do
          # Calculate seconds until next midnight KST
          CURRENT_HOUR=$$(TZ=Asia/Seoul date +%H)
          CURRENT_MIN=$$(TZ=Asia/Seoul date +%M)
          CURRENT_SEC=$$(TZ=Asia/Seoul date +%S)
          
          # Force base-10 interpretation to avoid octal number errors (08, 09)
          SECONDS_TODAY=$$((10#$$CURRENT_HOUR * 3600 + 10#$$CURRENT_MIN * 60 + 10#$$CURRENT_SEC))
          SECONDS_UNTIL_MIDNIGHT=$$((86400 - $$SECONDS_TODAY))
          
          echo \"[INFO] Current time: $$(TZ=Asia/Seoul date)\"
          echo \"[INFO] Next collection in $$SECONDS_UNTIL_MIDNIGHT seconds ($$(($$SECONDS_UNTIL_MIDNIGHT / 3600)) hours $$(($$SECONDS_UNTIL_MIDNIGHT % 3600 / 60)) minutes)\"
          
          # Sleep until midnight
          sleep $$SECONDS_UNTIL_MIDNIGHT
          
          # Run daily collection (Notion excluded - handled by notion-diff-collector)
          echo \"[INFO] ====== Starting daily data collection ======\"
          echo \"[INFO] Time: $$(TZ=Asia/Seoul date)\"
          python scripts/daily_data_collection_mongo.py --sources github slack drive
          echo \"[INFO] ====== Daily collection completed ======\"
          
          # Sleep 1 minute to avoid duplicate runs
          sleep 60
        done
      "

  # Notion Diff Collector (runs every minute for real-time change tracking)
  notion-diff-collector:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: all-thing-eye-notion-diff-collector
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Seoul

      # MongoDB Connection
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-all_thing_eye}

      # Notion API
      NOTION_TOKEN: ${NOTION_TOKEN}
    volumes:
      - ./config:/app/config:ro
      - ./data/logs/notion-diff:/app/logs
    networks:
      - all-thing-eye
    command: >
      bash -c "
        echo '[INFO] Notion Diff Collector starting...'
        echo '[INFO] Timezone: $$(date +%Z)'
        echo '[INFO] Waiting 30 seconds for backend to initialize...'
        sleep 30
        
        echo '[INFO] Starting Notion diff collection (every 1 minute)...'
        python scripts/collect_notion_diff.py --schedule 1
      "

  # Weekly Output Scheduler Bot (APScheduler-based long-lived process)
  weekly-bot:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: all-thing-eye-weekly-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Seoul
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-all_thing_eye}
      SLACK_WEEKLY_BOT_TOKEN: ${SLACK_WEEKLY_BOT_TOKEN}
    volumes:
      - ./data/logs/weekly-bot:/app/logs
    networks:
      - all-thing-eye
    command: >
      bash -c "
        echo '[INFO] Weekly Output Bot starting...'
        echo '[INFO] Timezone: $$(date +%Z)'
        echo '[INFO] Waiting 30 seconds for backend to initialize...'
        sleep 30

        echo '[INFO] Starting Weekly Output Bot (APScheduler)...'
        python scripts/weekly_output_bot.py
      "

# No local volumes needed - MongoDB is remote

networks:
  all-thing-eye:
    driver: bridge
