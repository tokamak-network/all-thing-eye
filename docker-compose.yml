version: "3.8"

services:
  # MongoDB Database
  mongodb:
    image: mongo:8.0
    container_name: all-thing-eye-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: all_thing_eye
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: all-thing-eye-backend
    restart: unless-stopped
    environment:
      # MongoDB connection
      MONGODB_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/all_thing_eye?authSource=admin
      MONGODB_DATABASE: all_thing_eye

      # GitHub Plugin
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_ORG: ${GITHUB_ORG}

      # Slack Plugin
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_USER_TOKEN: ${SLACK_USER_TOKEN}

      # Notion Plugin
      NOTION_TOKEN: ${NOTION_TOKEN}

      # Google Drive Plugin
      GOOGLE_APPLICATION_CREDENTIALS: /app/config/google-credentials.json
      GOOGLE_ADMIN_EMAIL: ${GOOGLE_ADMIN_EMAIL}
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend
      - ./src:/app/src
      - ./config:/app/config
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - app-network
    command: uvicorn backend.main_mongo:app --host 0.0.0.0 --port 8000 --reload

  # Next.js Frontend (Optional)
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: all-thing-eye-frontend
  #   restart: unless-stopped
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     NEXT_PUBLIC_API_URL: http://backend:8000
  #   depends_on:
  #     - backend
  #   networks:
  #     - app-network

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  app-network:
    driver: bridge
